好的，完全理解。如果您不打算使用强化学习，那么“奖励函数”的角色就从一个用于**训练策略网络**的信号，转变为一个用于**指导控制器**做出实时决策的**成本函数 (Cost Function)** 或 **效用函数 (Utility Function)**。

我们的目标是设计一个函数，它能在任何时刻评估无人机集群的“状态有多好”，控制器（无论是基于优化的、基于规则的还是其他经典控制器）的目标就是采取行动，使这个“状态”变得更好。在控制理论中，我们通常定义一个“成本”，并让控制器去**最小化**它。成本可以简单地看作是**负奖励**。

下面，我将为您提供一套详细的设计思想和方案，您可以将它交给代码助手来实现。

---

### 核心设计思想：从“奖励塑造”到“分层成本函数”

强化学习的奖励函数设计充满了“奖励塑造”（Reward Shaping），即用各种小的、密集的奖励来引导智能体探索。这对于训练是必要的，但对于一个已经有明确目标的控制器来说，则显得过于复杂和间接。

我们将采用**分层成本函数 (Hierarchical Cost Function)** 的思想。这意味着我们将成本分为几个具有不同优先级的类别。一个好的控制器应该：
1.  **绝对不能**违反最高优先级的约束（如安全）。
2.  在满足高优先级约束的前提下，**尽力**完成次高优先级的目标（如任务进展）。
3.  在以上都满足的情况下，**优化**低优先级的指标（如平滑度）。

我们将设计一个总成本函数 $J_{total}$，控制器的目标是在每个时间步选择一个动作 $a$ 来最小化这个 $J_{total}$。

$J_{total} = w_{safety} \cdot J_{safety} + w_{task} \cdot J_{task} + w_{efficiency} \cdot J_{efficiency}$

其中，$w$ 是权重，用于体现不同成本的优先级。

---

### 详细方案：三层成本函数设计

#### 第1层：安全成本 $J_{safety}$ (最高优先级)

这是“一票否决”项，必须不惜一切代价最小化。其权重 $w_{safety}$ 应该远大于其他项。

1.  **无人机间碰撞成本 $J_{collision}$**:
    * **思想**: 当无人机之间距离过近时，成本应急剧增加，形成一个强大的“斥力场”。
    * **方案**: 定义一个安全距离 $d_{safe}$（例如2倍无人机直径）。当两架无人机 $i$ 和 $j$ 之间的距离 $d_{ij}$ 小于 $d_{safe}$ 时，成本开始计算。成本函数应该是距离的倒数函数，这样在接近碰撞时成本会趋于无穷大。
    * **公式**:
        $$
        J_{collision} = \sum_{i \neq j}
        \begin{cases}
        (\frac{1}{d_{ij}} - \frac{1}{d_{safe}})^2 & \text{if } d_{ij} < d_{safe} \\
        0 & \text{otherwise}
        \end{cases}
        $$
        *平方项使得函数在 $d_{safe}$ 处平滑，有利于优化器。*

2.  **边界/地面碰撞成本 $J_{boundary}$**:
    * **思想**: 类似于无人机间碰撞，为飞行区域（特别是地面）设置一个“力场”。
    * **方案**: 定义一个最低安全高度 $h_{safe}$（例如0.5米）。当无人机 $i$ 的高度 $h_i$ 低于 $h_{safe}$ 时，成本急剧增加。
    * **公式**:
        $$
        J_{boundary} = \sum_{i}
        \begin{cases}
        (\frac{1}{h_i} - \frac{1}{h_{safe}})^2 & \text{if } h_i < h_{safe} \\
        0 & \text{otherwise}
        \end{cases}
        $$

**总安全成本**: $J_{safety} = J_{collision} + J_{boundary}$

#### 第2层：任务成本 $J_{task}$ (核心目标)

这是驱动无人机完成任务的主要动力。

1.  **任务进展成本 $J_{progress}$**:
    * **思想**: 这是最核心的驱动力。成本应该等于编队中心到当前目标的距离。最小化这个成本就等于飞向目标。
    * **方案**:
        a.  确定当前的目标点 $P_{target}$。这需要一个简单的逻辑判断：如果还有未通过的门，目标就是下一个门的中心；如果所有门都已通过，目标就是最终的终点。
        b.  计算无人机集群的几何中心 $P_{center}$。
        c.  成本就是两者距离的平方。平方的好处是它是一个平滑的二次函数，有唯一的最小值，非常适合控制器。
    * **公式**:
        $$
        J_{progress} = || P_{center} - P_{target} ||^2
        $$
        *这里的 $|| \cdot ||^2$ 表示欧几里得距离的平方。*

2.  **编队保持成本 $J_{formation}$**:
    * **思想**: 惩罚每架无人机偏离其在编队中理想位置的行为。这就像在编队中心和每架无人机之间连上了“虚拟的弹簧”。
    * **方案**:
        a.  对于每架无人机 $i$，根据编队中心 $P_{center}$ 和预设的编队构型（`self.formation`），计算出它的理想位置 $P_{ideal\_i}$。
        b.  成本是每架无人机的实际位置 $p_i$ 与其理想位置 $P_{ideal\_i}$ 之间距离平方的总和。
    * **公式**:
        $$
        J_{formation} = \sum_{i} || p_i - P_{ideal\_i} ||^2
        $$
        *其中 $P_{ideal\_i} = P_{center} + \text{offset}_i$。*

3.  **门对准与姿态成本 $J_{alignment}$** (可选，用于更精细的控制):
    * **思想**: 在接近门时，不仅要位置对，还要飞行方向对。应该鼓励编队以垂直于门的方向飞入。
    * **方案**:
        a.  计算编队的平均速度向量 $\vec{v}_{avg}$。
        b.  计算从编队中心指向门中心的向量 $\vec{d}_{gate}$。
        c.  成本是这两个向量之间夹角的函数。我们希望它们方向相同（点积为正且最大）。成本可以设为 $(1 - \cos(\theta))^2$，其中 $\cos(\theta)$ 可以通过单位向量的点积得到。
    * **公式**:
        $$
        J_{alignment} = (1 - \frac{\vec{v}_{avg} \cdot \vec{d}_{gate}}{||\vec{v}_{avg}|| \cdot ||\vec{d}_{gate}||})^2
        $$

**总任务成本**: $J_{task} = w_{prog} \cdot J_{progress} + w_{form} \cdot J_{formation} + w_{align} \cdot J_{alignment}$
*在任务成本内部，也存在权重。通常，`w_prog` 和 `w_form` 是最重要的。*

#### 第3层：效率成本 $J_{efficiency}$ (优化项)

在满足安全和任务要求后，我们希望飞行过程更平滑、更节能。

1.  **控制力度成本 $J_{effort}$**:
    * **思想**: 惩罚过大的控制指令（例如，电机推力过大）。这可以减少能耗并防止硬件过载。
    * **方案**: 成本是控制器输出的动作（action）向量 $a$ 的模长的平方。
    * **公式**:
        $$
        J_{effort} = ||a||^2
        $$

2.  **控制平滑度成本 $J_{smoothness}$**:
    * **思想**: 惩罚控制指令的剧烈变化。这能让无人机的飞行轨迹更平滑，避免急加速和急停。
    * **方案**: 成本是当前动作 $a_t$ 和上一个时间步动作 $a_{t-1}$ 之差的模长的平方。
    * **公式**:
        $$
        J_{smoothness} = ||a_t - a_{t-1}||^2
        $$

**总效率成本**: $J_{efficiency} = w_{effort} \cdot J_{effort} + w_{smooth} \cdot J_{smoothness}$

---

### 如何让代码助手实现

您可以向代码助手提出以下请求，并提供上述设计方案：

**请求示例:**
“请帮我重构 `FormationGateTraversal` 这个强化学习环境。我不再使用强化学习，而是需要一个成本函数来指导一个经典控制器（例如MPC或基于优化的规划器）。请在类中实现一个名为 `compute_total_cost` 的新方法。

这个方法的逻辑应该遵循以下设计：
1.  **输入**: 该方法应接收无人机集群的当前状态（所有无人机的位置、姿态、速度等）以及控制器的候选动作。
2.  **输出**: 返回一个单一的浮点数值，代表总成本。
3.  **实现细节**:
    * **分层成本**: 函数内部需要计算三层成本：安全成本、任务成本和效率成本。
    * **安全成本 ($J_{safety}$)**:
        * 计算无人机间的碰撞成本，当距离小于`d_safe`时，成本为 $(\frac{1}{d_{ij}} - \frac{1}{d_{safe}})^2$。
        * 计算与地面的碰撞成本，当高度低于`h_safe`时，成本为 $(\frac{1}{h_i} - \frac{1}{h_{safe}})^2$。
    * **任务成本 ($J_{task}$)**:
        * 首先，写一个辅助函数 `get_current_target()`，根据 `self.current_gate_idx` 判断当前目标是下一个门还是终点。
        * 计算任务进展成本 $J_{progress}$，即编队中心与当前目标距离的平方。
        * 计算编队保持成本 $J_{formation}$，即所有无人机与其理想位置偏差的平方和。
    * **效率成本 ($J_{efficiency}$)** (可选，可先不实现):
        * 计算控制力度成本 $J_{effort}$，即动作向量模长的平方。
    * **总成本**: 将上述所有成本项根据预设的权重（例如 `self.w_collision`, `self.w_progress` 等，这些权重可以添加到 `__init__` 中）加权求和，并返回结果。

请确保代码是向量化的（使用torch操作），以提高计算效率。”

这个详细的请求结合了上面的设计思想，应该能让代码助手为您生成一个高质量、非RL的成本函数，为后续的控制器开发打下坚实的基础。